// Copyright CERN and copyright holders of ALICE O2. This software is
// distributed under the terms of the GNU General Public License v3 (GPL
// Version 3), copied verbatim in the file "COPYING".
//
// See http://alice-o2.web.cern.ch/license for full licensing information.
//
// In applying this license CERN does not waive the privileges and immunities
// granted to it by virtue of its status as an Intergovernmental Organization
// or submit itself to any jurisdiction.

#if !defined(__CLING__) || defined(__ROOTCLING__)
#include "EMCALCalib/BadChannelMap.h"
#include "EMCALCalib/CalibDB.h"
#include "RStringView.h"
#include <ctime>
#include <iostream>
#endif

// functions getting test data
std::vector<unsigned short> getBadChannelsLHC18m_block1();
std::vector<unsigned short> getWarmChannelsLHC18m_block1();
std::vector<unsigned short> getDeadChannelsLHC18m_block1();

/// \brief Converting time into numerical time stamp representation
unsigned long create_timestamp(int year, int month, int day, int hour, int minutes, int seconds)
{
  struct tm timeinfo;
  timeinfo.tm_year = year;
  timeinfo.tm_mon = month;
  timeinfo.tm_mday = day;
  timeinfo.tm_hour = hour;
  timeinfo.tm_min = minutes;
  timeinfo.tm_sec = seconds;

  time_t timeformat = mktime(&timeinfo);
  return static_cast<unsigned long>(timeformat);
}

/// \brief Read-write test
///
/// Writing to EMCAL CCDB server
/// Attention: Might overwrite existing CCDB content - use with care!
void BadChannelMap_CalibDBtest(const std::string_view ccdbserver = "emcccdb-test.cern.ch")
{
  std::cout << "Using CCDB server " << ccdbserver << std::endl;
  o2::emcal::CalibDB ccdbhandler(ccdbserver);

  // Prepare database object
  o2::emcal::BadChannelMap* bcm = new o2::emcal::BadChannelMap;
  for (auto c : getDeadChannelsLHC18m_block1())
    bcm->addBadChannel(c, o2::emcal::BadChannelMap::MaskType_t::DEAD_CELL);
  for (auto c : getBadChannelsLHC18m_block1())
    bcm->addBadChannel(c, o2::emcal::BadChannelMap::MaskType_t::BAD_CELL);
  for (auto c : getWarmChannelsLHC18m_block1())
    bcm->addBadChannel(c, o2::emcal::BadChannelMap::MaskType_t::WARM_CELL);

  // Set time limits: These are from the start of the run validity range (290222) to the end of the run validity range (290292)
  auto rangestart = create_timestamp(2018, 7, 30, 10, 48, 44),
       rangeend = create_timestamp(2018, 8, 6, 0, 31, 52);
  std::cout << "Using time stamps " << rangestart << " and " << rangeend << std::endl;
  std::map<std::string, std::string> metadata;
  ccdbhandler.storeBadChannelMap(bcm, metadata, rangestart, rangeend);

  // Read bad channel map from CCDB, check whether they are the same
  // using test timestamp from next run (290223)
  auto rangetest = create_timestamp(2018, 7, 30, 12, 13, 20);
  std::cout << "Using read timestamp " << rangetest << "(omitted untill function is implemented server side)" << std::endl;
  o2::emcal::BadChannelMap* read(nullptr);
  try {
    read = ccdbhandler.readBadChannelMap(rangestart, metadata);
  } catch (o2::emcal::CalibDB::ObjectNotFoundException& oe) {
    std::cerr << "CCDB error: " << oe.what() << std::endl;
    return;
  } catch (o2::emcal::CalibDB::TypeMismatchException& te) {
    std::cout << "CCDB error: " << te.what() << std::endl;
    return;
  }
  if (!read) {
    std::cerr << "No object received from CCDB" << std::endl;
    return;
  }
  std::cout << "Obtained bad channel map from CCDB - test for match" << std::endl;
  if (*bcm == *read) {
    std::cout << "Bad channel maps matching - test successfull" << std::endl;
  } else {
    std::cerr << "Bad channel maps don't match" << std::endl;
  }
}

std::vector<unsigned short> getBadChannelsLHC18m_block1()
{
  return {103, 128, 152, 176, 191, 198, 287, 324, 328, 353, 384, 386, 387, 397, 399,
          434, 437, 443, 444, 447, 554, 592, 595, 655, 717, 720, 759, 764, 917, 1002,
          1022, 1038, 1050, 1175, 1204, 1222, 1288, 1327, 1329, 1366, 1376, 1380, 1382, 1384, 1386,
          1414, 1519, 1535, 1542, 1693, 1696, 1704, 1711, 1738, 1836, 1837, 1838, 1839, 1844, 1860,
          1867, 1892, 1961, 1963, 2014, 2020, 2022, 2026, 2094, 2126, 2127, 2161, 2193, 2196, 2245,
          2298, 2309, 2313, 2325, 2389, 2395, 2397, 2399, 2406, 2424, 2474, 2487, 2505, 2506, 2533,
          2534, 2540, 2544, 2575, 2581, 2586, 2624, 2665, 2682, 2787, 2797, 2805, 2823, 2824, 2825,
          2841, 2857, 2884, 2888, 2891, 2915, 2921, 2985, 3002, 3039, 3051, 3135, 3161, 3176, 3196,
          3223, 3236, 3244, 3259, 3297, 3307, 3339, 3353, 3397, 3403, 3488, 3493, 3503, 3551, 3732,
          3740, 3748, 3754, 3770, 3772, 3796, 3803, 3826, 3836, 3839, 3840, 3854, 3876, 3906, 3908,
          3914, 3916, 3940, 3962, 3974, 4011, 4027, 4058, 4098, 4100, 4129, 4212, 4230, 4236, 4237,
          4282, 4320, 4371, 4372, 4421, 4516, 4530, 4532, 4538, 4543, 4596, 4597, 4602, 4613, 4614,
          4621, 4627, 4637, 4642, 4643, 4646, 4647, 4648, 4649, 4650, 4651, 4652, 4653, 4655, 4688,
          4691, 4692, 4695, 4696, 4697, 4699, 4700, 4701, 4702, 4817, 4967, 5183, 5201, 5231, 5259,
          5263, 5267, 5295, 5328, 5330, 5354, 5411, 5414, 5420, 5448, 5469, 5560, 5698, 5831, 6064,
          6104, 6275, 6295, 6331, 6481, 6527, 6689, 6735, 6802, 6803, 6810, 6811, 6814, 6922, 6991,
          7150, 7371, 7375, 7430, 7491, 7507, 7581, 7583, 7595, 7747, 7751, 7774, 8005, 8047, 8165,
          8176, 8236, 8238, 8244, 8260, 8264, 8274, 8275, 8276, 8277, 8283, 8298, 8340, 8352, 8354,
          8355, 8356, 8357, 8358, 8360, 8361, 8362, 8365, 8372, 8404, 8420, 8436, 8577, 8578, 8584,
          8585, 8586, 8610, 8724, 8795, 8807, 8809, 8916, 8938, 9060, 9061, 9066, 9076, 9078, 9092,
          9098, 9140, 9146, 9179, 9216, 9217, 9222, 9253, 9259, 9262, 9269, 9275, 9286, 9288, 9291,
          9307, 9323, 9349, 9354, 9357, 9361, 9533, 9598, 9703, 9706, 9769, 9794, 9795, 9798, 9802,
          9806, 9807, 9815, 9818, 9819, 9823, 9825, 9829, 9831, 9836, 9837, 9849, 9884, 9886, 9892,
          9927, 9940, 9941, 9942, 9943, 9945, 9951, 10073, 10121, 10123, 10125, 10134, 10139, 10154, 10164,
          10196, 10203, 10267, 10325, 10326, 10331, 10357, 10363, 10451, 10474, 10596, 10609, 10706, 10707, 10723,
          10760, 10852, 10854, 10855, 10857, 10858, 10859, 10899, 10910, 10921, 10980, 10986, 10999, 11043, 11044,
          11052, 11091, 11241, 11286, 11363, 11589, 11738, 11867, 12052, 12068, 12134, 12142, 12216, 12287, 12317,
          12384, 12592, 12595, 12601, 12602, 12604, 12605, 12606, 12610, 12613, 12614, 12616, 12617, 12618, 12619,
          12621, 12622, 12801, 12802, 12805, 12806, 12809, 12813, 12831, 12864, 12865, 12867, 12869, 12870, 12871,
          12874, 12875, 12876, 12877, 12878, 12879, 12913, 12914, 12916, 12917, 12918, 12919, 12920, 12921, 12922,
          12923, 12924, 12925, 12926, 12927, 13049, 13053, 13055, 13059, 13064, 13068, 13126, 13172, 13193, 13236,
          13284, 13292, 13456, 13457, 13461, 13462, 13463, 13464, 13466, 13467, 13470, 13471, 13508, 13514, 13556,
          13562, 13761, 13920, 13931, 13943, 13953, 13984, 13985, 13988, 13989, 13990, 13991, 13994, 13995, 13996,
          13997, 13998, 13999, 14042, 14081, 14145, 14153, 14157, 14191, 14193, 14232, 14234, 14236, 14239, 14248,
          14249, 14313, 14320, 14325, 14374, 14378, 14381, 14485, 14498, 14534, 14543, 14557, 14595, 14625, 14628,
          14632, 14636, 14639, 14641, 14644, 14649, 14678, 14679, 14706, 14707, 14709, 14710, 14712, 14714, 14715,
          14716, 14719, 14772, 14832, 14862, 14863, 14867, 14874, 14877, 14880, 14882, 14895, 14977, 14993, 15012,
          15094, 15098, 15156, 15201, 15202, 15204, 15207, 15208, 15209, 15210, 15211, 15212, 15213, 15214, 15255,
          15305, 15307, 15314, 15349, 15456, 15458, 15460, 15461, 15462, 15463, 15464, 15465, 15466, 15468, 15469,
          15480, 15483, 15489, 15505, 15506, 15507, 15510, 15511, 15513, 15514, 15515, 15518, 15519, 15563, 15641,
          15646, 15653, 15690, 15707, 15719, 15776, 15777, 15785, 15797, 15821, 15859, 15860, 15863, 15869, 15870,
          15871, 15872, 15874, 15904, 15906, 15912, 15916, 15920, 15921, 15923, 15926, 15927, 15928, 15929, 15933,
          15958, 15965, 16033, 16073, 16083, 16215, 16268, 16304, 16305, 16306, 16307, 16308, 16309, 16311, 16312,
          16313, 16316, 16318, 16324, 16349, 16413, 16468, 16469, 16477, 16480, 16481, 16482, 16483, 16484, 16485,
          16488, 16489, 16491, 16492, 16493, 16495, 16500, 16501, 16502, 16503, 16507, 16508, 16509, 16529, 16531,
          16532, 16533, 16534, 16535, 16536, 16538, 16540, 16541, 16542, 16543, 16576, 16577, 16578, 16585, 16586,
          16610, 16616, 16620, 16634, 16741, 16784, 16785, 16789, 16886, 16887, 16888, 16913, 16928, 16971, 16977,
          17129, 17203, 17206, 17207, 17211, 17214, 17280, 17300, 17408, 17413, 17504, 17531, 17595, 17597, 17636,
          17651, 17652, 17654, 17655, 17660, 17662, 17663};
}

std::vector<unsigned short> getWarmChannelsLHC18m_block1()
{
  return {35, 68, 145, 192, 385, 388, 389, 390, 391, 392, 393, 394, 395, 396, 398,
          432, 433, 435, 436, 438, 439, 440, 441, 442, 445, 446, 594, 597, 598, 599,
          862, 1054, 1056, 1057, 1391, 1857, 1859, 1861, 1863, 1865, 1869, 1871, 1876, 1968, 2190,
          2209, 2211, 2213, 2215, 2217, 2219, 2221, 2223, 2244, 2350, 2421, 2542, 2678, 2688, 2793,
          2795, 2880, 2904, 3394, 3413, 3485, 3759, 4107, 4414, 4635, 4753, 5470, 5714, 5767, 6049,
          6094, 6141, 6673, 6720, 6721, 6808, 6813, 7056, 7101, 7102, 7104, 7105, 7148, 7390, 7871,
          8222, 8359, 8638, 8686, 9120, 9408, 9799, 9803, 9805, 10201, 10206, 10322, 10560, 10565, 10572,
          10657, 10658, 10659, 10660, 10661, 10662, 10663, 10664, 10665, 10666, 10667, 10668, 10670, 10671, 10702,
          10703, 10704, 10705, 10708, 10709, 10714, 10716, 10717, 10719, 10752, 10759, 10779, 10814, 10815, 10851,
          10853, 10856, 10862, 10863, 10896, 10898, 10902, 10904, 10906, 10908, 10909, 10911, 11040, 11042, 11048,
          11050, 11051, 11054, 11089, 11090, 11093, 11095, 11096, 11097, 11099, 11102, 11103, 11132, 11135, 11138,
          11141, 11148, 11150, 11197, 11198, 11280, 11329, 11380, 11553, 11630, 11647, 11937, 12260, 12270, 12276,
          12385, 12478, 12611, 12615, 12623, 12872, 12912, 12988, 13056, 13058, 13066, 13067, 13281, 13290, 13294,
          13383, 13433, 13458, 13460, 13465, 13469, 13554, 13871, 13921, 13941, 13944, 13971, 13986, 14060, 14107,
          14225, 14229, 14231, 14495, 14686, 14704, 14708, 14717, 15120, 15269, 15309, 15315, 15322, 15323, 15450,
          15749, 15753, 15758, 15856, 15857, 15858, 15861, 15862, 15864, 15865, 15866, 15867, 15868, 15905, 15907,
          15908, 15909, 15910, 15911, 15913, 15914, 15915, 15917, 15918, 15919, 15967, 16096, 16127, 16317, 16365,
          16471, 16479, 16487, 16490, 16497, 16667, 16686, 16897, 16961, 17061, 17117, 17151, 17265, 17376, 17457,
          17501, 17593, 17631};
}

std::vector<unsigned short> getDeadChannelsLHC18m_block1()
{
  return {1534, 2047, 2112, 2113, 2114, 2115, 2116, 2117, 2118, 2119, 2120, 2121, 2122, 2123, 2124,
          2125, 2776, 4640, 4641, 4644, 4645, 4654, 4689, 4690, 4693, 4694, 4698, 4703, 8353, 8505,
          8576, 8579, 8580, 8581, 8582, 8583, 8587, 8588, 8589, 8590, 8591, 8743, 9282, 9828, 11462,
          12147, 12593, 12594, 12596, 12597, 12598, 12599, 12600, 12603, 12607, 12800, 12803, 12804, 12807, 12808,
          12810, 12811, 12812, 12814, 12815, 12866, 12868, 12873, 12915, 13152, 13153, 13154, 13155, 13156, 13157,
          13158, 13159, 13160, 13161, 13162, 13163, 13164, 13165, 13166, 13167, 13200, 13201, 13202, 13203, 13204,
          13205, 13206, 13207, 13208, 13209, 13210, 13211, 13212, 13213, 13214, 13215, 13524, 13589, 13848, 13969,
          14443, 14624, 14626, 14627, 14629, 14630, 14631, 14633, 14634, 14635, 14637, 14638, 15051, 15200, 15203,
          15205, 15206, 15215, 15217, 15457, 15459, 15467, 15470, 15471, 15504, 15508, 15509, 15512, 15516, 15517,
          15624, 15963, 16395, 16528, 16530, 16537, 16539, 16579, 16580, 16581, 16582, 16583, 16584, 16587, 16588,
          16589, 16590, 16591, 16608, 16609, 16611, 16612, 16613, 16614, 16615, 16617, 16618, 16619, 16621, 16622,
          16623, 17200, 17201, 17202, 17204, 17205, 17208, 17209, 17210, 17212, 17213, 17215, 17648, 17649, 17650,
          17653, 17656, 17657, 17658, 17659, 17661};
}
